<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>StakeWatch</title>

  <style>
    /* =========================
       THEME (Dark default)
       ========================= */
    :root{
      --bg: #0b1220;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.04);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.45);
      --line: rgba(255,255,255,0.10);
      --shadow: 0 20px 60px rgba(0,0,0,0.45);

      --pillBg: rgba(255,255,255,0.08);
      --pillBorder: rgba(255,255,255,0.12);

      --accent: rgba(120, 153, 255, 0.95);
      --accent2: rgba(160, 120, 255, 0.95);

      --strong: rgba(255,255,255,0.95);

      --sigStrong: rgba(255,255,255,0.95); /* keep neutral, premium */
      --sigMid: rgba(255,255,255,0.85);
      --sigInfo: rgba(255,255,255,0.55);
      --row8k: rgba(255,255,255,0.45);
    }

    /* Light theme */
    body[data-theme="light"]{
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel2: #fbfbfe;
      --text: rgba(17,24,39,0.95);
      --muted: rgba(17,24,39,0.60);
      --muted2: rgba(17,24,39,0.45);
      --line: rgba(17,24,39,0.10);
      --shadow: 0 18px 45px rgba(17,24,39,0.08);

      --pillBg: rgba(17,24,39,0.06);
      --pillBorder: rgba(17,24,39,0.12);

      --accent: rgba(59, 130, 246, 1);
      --accent2: rgba(139, 92, 246, 1);

      --strong: rgba(17,24,39,0.96);

      --sigStrong: rgba(17,24,39,0.95);
      --sigMid: rgba(17,24,39,0.85);
      --sigInfo: rgba(17,24,39,0.55);
      --row8k: rgba(17,24,39,0.45);
    }

    /* =========================
       Base layout
       ========================= */
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(120,153,255,0.22), transparent 55%),
        radial-gradient(900px 520px at 85% 0%, rgba(160,120,255,0.18), transparent 60%),
        radial-gradient(900px 650px at 50% 120%, rgba(120,153,255,0.12), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 16px 30px;
    }

    /* Top header card */
    .top{
      background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    h1{
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.2px;
      line-height: 1.1;
    }

    .subtitle{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 880px;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .chipBtn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      user-select:none;
    }
    .chipBtn:hover{
      border-color: rgba(255,255,255,0.18);
      transform: translateY(-1px);
      transition: 120ms ease;
    }
    body[data-theme="light"] .chipBtn:hover{
      border-color: rgba(17,24,39,0.18);
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 4px rgba(120,153,255,0.12);
      margin-top: 3px;
    }

    /* Controls panel */
    .panel{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .controls{
      display:grid;
      grid-template-columns: 170px 220px 1fr 120px auto;
      gap: 10px;
      align-items:center;
    }

    @media (max-width: 900px){
      .controls{
        grid-template-columns: 1fr 1fr;
      }
      .controls .wide{ grid-column: 1 / -1; }
    }

    select, input{
      width: 100%;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    select:focus, input:focus{
      border-color: rgba(120,153,255,0.45);
      box-shadow: 0 0 0 4px rgba(120,153,255,0.14);
    }
    body[data-theme="light"] select:focus,
    body[data-theme="light"] input:focus{
      box-shadow: 0 0 0 4px rgba(59,130,246,0.14);
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 11px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--panel2);
      color: var(--text);
      font-size:14px;
      user-select:none;
      white-space:nowrap;
    }
    .toggle input{
      width:auto;
      margin:0;
      accent-color: var(--accent);
    }

    .btnPrimary{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(120,153,255,0.40);
      background: linear-gradient(135deg, rgba(120,153,255,0.25), rgba(160,120,255,0.20));
      color: var(--text);
      cursor: pointer;
      font-size: 14px;
      white-space:nowrap;
    }
    .btnPrimary:hover{
      border-color: rgba(120,153,255,0.60);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      transition: 140ms ease;
    }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Table card */
    .tableCard{
      margin-top: 14px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      letter-spacing: 0.2px;
      position: sticky;
      top: 0;
      z-index: 1;
      border-bottom: 1px solid var(--line);
      white-space: nowrap;
    }
    body[data-theme="light"] thead th{
      background: #f5f6fb;
    }

    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    tbody tr:hover{
      background: rgba(255,255,255,0.03);
    }
    body[data-theme="light"] tbody tr:hover{
      background: rgba(17,24,39,0.03);
    }

    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--pillBorder);
      background: var(--pillBg);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }

    .ktext{
      font-weight: 650;
      color: var(--strong);
      line-height: 1.25;
    }

    .nowrap{ white-space: nowrap; }
    .muted{ color: var(--muted2); font-size: 12px; }

    a{
      color: var(--accent);
      text-decoration: none;
      word-break: break-all;
    }
    a:hover{ text-decoration: underline; }

    /* Signals */
    .sig{ font-weight: 700; letter-spacing: 0.2px; }
    .sig-strong{ color: var(--sigStrong); }
    .sig-mid{ color: var(--sigMid); }
    .sig-info{ color: var(--sigInfo); }

    /* 8-K de-emphasis */
    tr.row-8k td{ color: var(--row8k); }
    tr.row-8k .ktext{ color: var(--row8k); font-weight: 600; }
    tr.row-8k a{ color: var(--muted); }

    /* Small footer */
    .foot{
      margin-top: 12px;
      color: var(--muted2);
      font-size: 12px;
      text-align:center;
    }
  </style>
</head>

<body data-theme="dark">
  <div class="wrap">

    <div class="top">
      <div class="topbar">
        <div style="display:flex;gap:10px;align-items:flex-start;">
          <div class="dot" aria-hidden="true"></div>
          <div>
            <h1>StakeWatch</h1>
            <div class="subtitle">
              USA: SEC 13D/13G/8-K ‚Ä¢ Deutschland: EQS-Stimmrechte.<br>
              Fokus: <b>WER</b> macht <b>WAS</b> mit <b>WEM</b> ‚Äì inkl. Prozent (wenn verf√ºgbar). Zeiten: UTC.
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="chipBtn" id="themeBtn" title="Theme wechseln">üåô Dark</button>
          <button class="chipBtn" id="openSignals" title="Nur Signale anzeigen">üî•/‚ö†Ô∏è Fokus</button>
        </div>
      </div>

      <div class="panel">
        <div class="controls">
          <select id="region">
            <option value="">Alle Regionen</option>
            <option value="US">USA</option>
            <option value="DE">Deutschland</option>
          </select>

          <select id="event">
            <option value="">Alle Ereignisse</option>
            <option value="SC 13D">SC 13D (strategisch)</option>
            <option value="SC 13G">SC 13G (passiv)</option>
            <option value="8-K">8-K (Info)</option>
            <option value="Stimmrechte">DE Stimmrechte</option>
          </select>

          <input class="wide" id="q" placeholder="Suche: Firma / Name / Text ‚Ä¶">

          <select id="limit">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="250">250</option>
            <option value="1000">1000</option>
          </select>

          <label class="toggle">
            <input id="onlySignals" type="checkbox">
            nur Signale (üî•/‚ö†Ô∏è)
          </label>
          <label class="toggle">
  <input id="important8k" type="checkbox" checked>
  8-K: nur wichtig
</label>

          <button class="btnPrimary" id="reload">Neu laden</button>
        </div>

        <div class="status">
          <div id="status">Lade Daten‚Ä¶</div>
          <div id="status2" class="muted"></div>
        </div>
      </div>
    </div>

    <div class="tableCard">
      <table>
        <thead>
          <tr>
            <th>Signal</th>
            <th>Klartext</th>
            <th class="nowrap">Zeit (UTC)</th>
            <th>Region</th>
            <th>Ereignis</th>
            <th>WER (Buyer / Melder)</th>
            <th>WEM (Target / Emittent)</th>
            <th class="nowrap">%</th>
            <th>Quelle</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="foot">StakeWatch ‚Ä¢ l√§uft automatisch √ºber GitHub Actions ‚Ä¢ 8-K ist bewusst dezent dargestellt</div>
  </div>

<script>
let all = [];

async function loadData(){
  const s = document.getElementById("status");
  const s2 = document.getElementById("status2");
  s.textContent = "Lade Daten‚Ä¶";
  s2.textContent = "";
  const res = await fetch("./data.json?x=" + Date.now());
  all = await res.json();
  s.textContent = `Geladen: ${all.length} Eintr√§ge.`;
  render();
}

function norm(s){ return (s || "").toString().toLowerCase(); }
function pill(text){ return `<span class="pill">${text || "‚Äî"}</span>`; }

function getSignal(x){
  function prettyEvent(ev, reg){
  if(reg === "DE" && ev === "Stimmrechte") return "Stimmrechtsmeldung (DE)";
  if(ev === "SC 13D") return "Strategischer Einstieg >5% (US)";
  if(ev === "SC 13G") return "Passiver Einstieg >5% (US)";
  if(ev === "8-K") return "Unternehmens-News (US)";
  return ev || "‚Äî";
}

function score8kTitle(title){
  const t = norm(title);

  const strong = [
    "merger", "acquisition", "acquire", "tender offer", "business combination",
    "definitive agreement", "purchase agreement", "sale of", "strategic transaction"
  ];

  const medium = [
    "agreement", "credit", "loan", "financing", "notes", "offering",
    "private placement", "registered direct", "warrant", "equity", "shelf",
    "bankruptcy", "restructuring", "delisting", "nasdaq", "nyse",
    "litigation", "investigation", "settlement"
  ];

  const earnings = [
    "earnings", "guidance", "results", "quarter", "fiscal", "outlook",
    "preliminary", "unaudited"
  ];

  const weak = [
    "bylaws", "certificate of", "charter", "amendment",
    "10b5-1", "trading plan",
    "press release", "presentation", "investor presentation",
    "regulation fd", "reg fd",
    "other events", "other"
  ];

  let score = 0;
  for(const k of strong) if(t.includes(k)) score += 4;
  for(const k of medium) if(t.includes(k)) score += 2;
  for(const k of earnings) if(t.includes(k)) score += 2;
  for(const k of weak) if(t.includes(k)) score -= 1;

  if(t.includes("item ") && t.match(/item\s+\d+\.\d+/)) score -= 1;
  return score;
}

function isImportant8k(x){
  if((x.event || "") !== "8-K") return true;
  const s = score8kTitle(x.title || "");
  return s >= 2;
}
  const ev = (x.event || "").toUpperCase();
  if(ev === "SC 13D" || (x.region === "DE" && x.event === "Stimmrechte")) return {icon:"üî•", cls:"sig-strong", label:"Stark"};
  if(ev === "SC 13G") return {icon:"‚ö†Ô∏è", cls:"sig-mid", label:"Beobachten"};
  return {icon:"‚ÑπÔ∏è", cls:"sig-info", label:"Info"};
}
function category8k(title){
  const t = norm(title);

  if(t.includes("merger") || t.includes("acquisition") || t.includes("tender offer") || t.includes("business combination"))
    return "M&A";

  if(t.includes("offering") || t.includes("financing") || t.includes("credit") || t.includes("loan") || t.includes("notes") || t.includes("private placement") || t.includes("registered direct") || t.includes("warrant"))
    return "Finanzierung";

  if(t.includes("earnings") || t.includes("results") || t.includes("guidance") || t.includes("outlook") || t.includes("quarter") || t.includes("fiscal") || t.includes("preliminary") || t.includes("unaudited"))
    return "Earnings";

  if(t.includes("litigation") || t.includes("investigation") || t.includes("settlement"))
    return "Recht";

  if(t.includes("bylaws") || t.includes("charter") || t.includes("amendment") || t.includes("board") || t.includes("director") || t.includes("officer") || t.includes("resignation") || t.includes("appointment"))
    return "Governance";

  return "News";
}

function fmtPercent(p){
  if(p === null || p === undefined || p === "") return "";
  return String(p).trim();
}

function issuerFromTitleDE(title){
  const t = title || "";
  const m = t.match(/Stimmrechte\s*:\s*(.+?)(?:\s+-\s+|\||$)/i);
  return m ? m[1].trim() : "";
}

function companyFromSecTitle(title){
  const t = title || "";
  const m = t.match(/-\s*(.+?)\s*\(\d{6,}\)/);
  return m ? m[1].trim() : "";
}

function buildKlartext(x){
  const reg = x.region || "";
  const ev  = x.event || "";
  const buyer = (x.buyer || "").trim();
  let target = (x.target || "").trim();
  const pct = fmtPercent(x.percent);

  if(reg === "DE" && ev === "Stimmrechte"){
    if(!target) target = issuerFromTitleDE(x.title);
    const who = buyer || "Ein Meldepflichtiger";
    const what = pct ? `meldet ${pct} %` : "meldet eine Stimmrechts√§nderung";
    const whom = target ? `an ${target}` : "bei einem Emittenten";
    return `${who} ${what} ${whom} (DE)`;
  }

  if(ev === "SC 13D"){
    const t = target || companyFromSecTitle(x.title) || "ein Unternehmen";
    const who = buyer || "Ein Investor";
    const what = pct ? `steigt strategisch mit ${pct} % ein` : "reicht eine strategische Beteiligungsmeldung (13D) ein";
    return `${who} ${what} bei ${t} (US)`;
  }

  if(ev === "SC 13G"){
    const t = target || companyFromSecTitle(x.title) || "ein Unternehmen";
    const who = buyer || "Ein Investor";
    const what = pct ? `meldet passiv ${pct} %` : "reicht eine passive Beteiligungsmeldung (13G) ein";
    return `${who} ${what} bei ${t} (US)`;
  }

  if(ev === "8-K"){
  const t = companyFromSecTitle(x.title) || "ein Unternehmen";
  const cat = category8k(x.title || "");
  return `${cat}: 8-K Meldung von ${t} (US)`;
}

  return `${ev || "Meldung"} (${reg || "‚Äî"})`;
}

function render(){
  const region = document.getElementById("region").value.trim();
  const event = document.getElementById("event").value.trim();
  const q = norm(document.getElementById("q").value.trim());
  const limit = parseInt(document.getElementById("limit").value, 10);
  const onlySignals = document.getElementById("onlySignals").checked;
  const important8k = document.getElementById("important8k").checked;

  let data = all;

  if(region) data = data.filter(x => (x.region || "") === region);
  if(event) data = data.filter(x => (x.event || "") === event);

  if(onlySignals){
    data = data.filter(x => {
      const ev = (x.event || "").toUpperCase();
      return ev === "SC 13D" || ev === "SC 13G" || (x.region === "DE" && x.event === "Stimmrechte");
    });
  }
  if(important8k){
  data = data.filter(x => isImportant8k(x));
}

  if(q){
    data = data.filter(x => {
      const klar = buildKlartext(x);
      const hay = [x.title, x.event, x.region, x.source, x.buyer, x.target, x.percent, x.link, klar]
        .map(norm).join(" | ");
      return hay.includes(q);
    });
  }

  data = data.slice(0, limit);

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  for(const x of data){
    const tr = document.createElement("tr");

    const sig = getSignal(x);
    const klar = buildKlartext(x);

    const time = x.time_utc || "";
    const reg = x.region || "";
    const ev  = x.event || "";
    const buyer = (x.buyer || "").trim();
    const target = (x.target || "").trim();
    const percent = fmtPercent(x.percent);

    if(ev === "8-K") tr.classList.add("row-8k");

    tr.innerHTML = `
      <td class="nowrap sig ${sig.cls}" title="${sig.label}">${sig.icon}</td>
      <td class="ktext">${klar}</td>
      <td class="nowrap">${time}</td>
      <td>${pill(reg)}</td>
      <td>${pill(prettyEvent(ev, reg))}</td>
      <td>${buyer ? buyer : `<span class="muted">‚Äî</span>`}</td>
      <td>${target ? target : `<span class="muted">‚Äî</span>`}</td>
      <td class="nowrap">${percent ? percent : `<span class="muted">‚Äî</span>`}</td>
      <td><a href="${x.link}" target="_blank" rel="noopener">√ñffnen</a></td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("status").textContent = `Anzeige: ${data.length} von ${all.length} Eintr√§gen.`;
  document.getElementById("status2").textContent = onlySignals ? "Filter: nur Signale aktiv" : "";
}

function setTheme(theme){
  document.body.setAttribute("data-theme", theme);
  localStorage.setItem("stakewatch_theme", theme);
  const btn = document.getElementById("themeBtn");
  btn.textContent = (theme === "light") ? "‚òÄÔ∏è Light" : "üåô Dark";
}

document.getElementById("reload").onclick = loadData;
document.getElementById("region").onchange = render;
document.getElementById("event").onchange = render;
document.getElementById("limit").onchange = render;
document.getElementById("q").oninput = render;
document.getElementById("onlySignals").onchange = render;

document.getElementById("openSignals").onclick = () => {
  const cb = document.getElementById("onlySignals");
  cb.checked = !cb.checked;
  render();
};

document.getElementById("themeBtn").onclick = () => {
  const cur = document.body.getAttribute("data-theme") || "dark";
  setTheme(cur === "dark" ? "light" : "dark");
};

(() => {
  const saved = localStorage.getItem("stakewatch_theme");
  if(saved === "light" || saved === "dark") setTheme(saved);
  else setTheme("dark");
  loadData();
})();
</script>
</body>
</html>
