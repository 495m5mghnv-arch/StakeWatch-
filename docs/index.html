<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>StakeWatch</title>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#6b7280; --line:#e5e7eb;
      --pill:#f3f4f6; --head:#fafafa;
      --strong:#111827; --soft:#9ca3af;
    }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 18px;
      background: var(--bg);
      color: var(--text);
    }
    h1{ margin: 0 0 6px 0; }
    .sub{ color:var(--muted); font-size:14px; margin-bottom:14px; line-height:1.35; }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin: 12px 0 10px 0;
    }
    select,input,button,label{
      padding:8px 10px; border-radius:10px; border:1px solid #d1d5db; font-size:14px;
      background: #fff;
    }
    button{ cursor:pointer; }
    .status{ color:var(--muted); font-size:13px; margin: 6px 0 10px 0; }

    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; border-bottom:1px solid var(--line); vertical-align:top; text-align:left; }
    th{ background:var(--head); position:sticky; top:0; z-index:1; }
    .pill{
      display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid #e5e7eb;
      font-size:12px; background:var(--pill);
      white-space:nowrap;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .nowrap{ white-space:nowrap; }
    a{ word-break:break-all; }

    /* Signal styles */
    .sig{ font-weight:600; }
    .sig-strong{ color:#111; }
    .sig-mid{ color:#111; }
    .sig-info{ color:var(--soft); }

    /* Make 8-K rows visually quieter */
    tr.row-8k td{
      color: var(--soft);
    }
    tr.row-8k td a{
      color: #6b7280;
    }

    .ktext{
      font-weight:600;
      color: var(--strong);
      line-height:1.25;
    }
    tr.row-8k .ktext{
      font-weight:500;
      color: var(--soft);
    }
  </style>
</head>

<body>
  <h1>StakeWatch</h1>
  <div class="sub">
    √úbersicht √ºber Meldungen (USA: SEC 13D/13G/8-K, Deutschland: EQS-Stimmrechte).<br>
    Ziel: <b>WER</b> macht <b>WAS</b> mit <b>WEM</b> ‚Äì inkl. Prozent (wenn verf√ºgbar).<br>
    <span class="muted">Hinweis: Zeiten sind UTC.</span>
  </div>

  <div class="controls">
    <select id="region">
      <option value="">Alle Regionen</option>
      <option value="US">USA</option>
      <option value="DE">Deutschland</option>
    </select>

    <select id="event">
      <option value="">Alle Ereignisse</option>
      <option value="SC 13D">SC 13D (strategisch)</option>
      <option value="SC 13G">SC 13G (passiv)</option>
      <option value="8-K">8-K (Info)</option>
      <option value="Stimmrechte">DE Stimmrechte</option>
    </select>

    <input id="q" placeholder="Suche: Firma / Name / Text ‚Ä¶" size="28">

    <select id="limit">
      <option value="50">50</option>
      <option value="100" selected>100</option>
      <option value="250">250</option>
      <option value="1000">1000</option>
    </select>

    <label style="display:flex;gap:8px;align-items:center;border:1px solid #d1d5db;border-radius:10px;padding:6px 10px;">
      <input id="onlySignals" type="checkbox" style="padding:0;margin:0;">
      nur Signale (üî•/‚ö†Ô∏è)
    </label>

    <button id="reload">Neu laden</button>
  </div>

  <div id="status" class="status"></div>

  <table>
    <thead>
      <tr>
        <th>Signal</th>
        <th>Klartext</th>
        <th class="nowrap">Zeit (UTC)</th>
        <th>Region</th>
        <th>Ereignis</th>
        <th>WER (Buyer / Melder)</th>
        <th>WEM (Target / Emittent)</th>
        <th class="nowrap">%</th>
        <th>Quelle</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

<script>
let all = [];

async function loadData(){
  const status = document.getElementById("status");
  status.textContent = "Lade Daten‚Ä¶";
  const res = await fetch("./data.json?x=" + Date.now());
  all = await res.json();
  status.textContent = `Geladen: ${all.length} Eintr√§ge.`;
  render();
}

function norm(s){ return (s || "").toString().toLowerCase(); }
function pill(text){ return `<span class="pill">${text || "‚Äî"}</span>`; }

function getSignal(x){
  const ev = (x.event || "").toUpperCase();
  if(ev === "SC 13D" || (x.region === "DE" && x.event === "Stimmrechte")) return {icon:"üî•", cls:"sig-strong", label:"Stark"};
  if(ev === "SC 13G") return {icon:"‚ö†Ô∏è", cls:"sig-mid", label:"Beobachten"};
  return {icon:"‚ÑπÔ∏è", cls:"sig-info", label:"Info"};
}

function fmtPercent(p){
  if(p === null || p === undefined || p === "") return "";
  const s = String(p).trim();
  // keep as-is if already has comma/dot
  return s;
}

function issuerFromTitleDE(title){
  // fallback: "EQS-Stimmrechte: XYZ - ..."
  const t = title || "";
  const m = t.match(/Stimmrechte\s*:\s*(.+?)(?:\s+-\s+|\||$)/i);
  return m ? m[1].trim() : "";
}

function companyFromSecTitle(title){
  // "8-K - COMPANY NAME (0000...) (Filer)"
  const t = title || "";
  const m = t.match(/-\s*(.+?)\s*\(\d{6,}\)/);
  return m ? m[1].trim() : "";
}

function buildKlartext(x){
  const reg = x.region || "";
  const ev  = x.event || "";
  const buyer = (x.buyer || "").trim();
  let target = (x.target || "").trim();
  const pct = fmtPercent(x.percent);

  if(reg === "DE" && ev === "Stimmrechte"){
    if(!target) target = issuerFromTitleDE(x.title);
    const who = buyer || "Ein Meldepflichtiger";
    const what = pct ? `meldet ${pct} %` : "meldet eine Stimmrechts√§nderung";
    const whom = target ? `an ${target}` : "bei einem Emittenten";
    return `${who} ${what} ${whom} (DE)`;
  }

  if(ev === "SC 13D"){
    const t = target || companyFromSecTitle(x.title) || "ein Unternehmen";
    const who = buyer || "Ein Investor";
    const what = pct ? `steigt strategisch mit ${pct} % ein` : "reicht eine strategische Beteiligungsmeldung (13D) ein";
    return `${who} ${what} bei ${t} (US)`;
  }

  if(ev === "SC 13G"){
    const t = target || companyFromSecTitle(x.title) || "ein Unternehmen";
    const who = buyer || "Ein Investor";
    const what = pct ? `meldet passiv ${pct} %` : "reicht eine passive Beteiligungsmeldung (13G) ein";
    return `${who} ${what} bei ${t} (US)`;
  }

  if(ev === "8-K"){
    const t = companyFromSecTitle(x.title) || "ein Unternehmen";
    return `8-K Unternehmensmeldung von ${t} (US)`;
  }

  // fallback
  return `${ev || "Meldung"} (${reg || "‚Äî"})`;
}

function render(){
  const region = document.getElementById("region").value.trim();
  const event = document.getElementById("event").value.trim();
  const q = norm(document.getElementById("q").value.trim());
  const limit = parseInt(document.getElementById("limit").value, 10);
  const onlySignals = document.getElementById("onlySignals").checked;

  let data = all;

  if(region) data = data.filter(x => (x.region || "") === region);
  if(event) data = data.filter(x => (x.event || "") === event);

  if(onlySignals){
    data = data.filter(x => {
      const ev = (x.event || "").toUpperCase();
      return ev === "SC 13D" || ev === "SC 13G" || (x.region === "DE" && x.event === "Stimmrechte");
    });
  }

  if(q){
    data = data.filter(x => {
      const klar = buildKlartext(x);
      const hay = [
        x.title, x.event, x.region, x.source, x.buyer, x.target, x.percent, x.link, klar
      ].map(norm).join(" | ");
      return hay.includes(q);
    });
  }

  data = data.slice(0, limit);

  const tbody = document.getElementById("rows");
  tbody.innerHTML = "";

  for(const x of data){
    const tr = document.createElement("tr");

    const sig = getSignal(x);
    const klar = buildKlartext(x);

    const time = x.time_utc || "";
    const reg = x.region || "";
    const ev  = x.event || "";
    const buyer = (x.buyer || "").trim();
    const target = (x.target || "").trim();
    const percent = fmtPercent(x.percent);

    if(ev === "8-K") tr.classList.add("row-8k");

    tr.innerHTML = `
      <td class="nowrap sig ${sig.cls}" title="${sig.label}">${sig.icon}</td>
      <td class="ktext">${klar}</td>
      <td class="nowrap">${time}</td>
      <td>${pill(reg)}</td>
      <td>${pill(ev)}</td>
      <td>${buyer ? buyer : `<span class="muted">‚Äî</span>`}</td>
      <td>${target ? target : `<span class="muted">‚Äî</span>`}</td>
      <td class="nowrap">${percent ? percent : `<span class="muted">‚Äî</span>`}</td>
      <td><a href="${x.link}" target="_blank" rel="noopener">√ñffnen</a></td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("status").textContent = `Anzeige: ${data.length} von ${all.length} Eintr√§gen.`;
}

document.getElementById("reload").onclick = loadData;
document.getElementById("region").onchange = render;
document.getElementById("event").onchange = render;
document.getElementById("limit").onchange = render;
document.getElementById("q").oninput = render;
document.getElementById("onlySignals").onchange = render;

loadData();
</script>
</body>
</html>
